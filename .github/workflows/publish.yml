name: Publish to Maven Central

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v1.2.1, v1.3.0 ç­‰æ ‡ç­¾æ—¶è§¦å‘

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v3
      with:
        gradle-version: wrapper

    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Extract version from tag
      id: extract_version
      run: |
        # ä»æ ‡ç­¾ä¸­æå–ç‰ˆæœ¬å· (v1.2.1 -> 1.2.1)
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: $VERSION"

    - name: Verify version matches gradle.properties
      run: |
        # æ£€æŸ¥æ ‡ç­¾ç‰ˆæœ¬æ˜¯å¦ä¸ gradle.properties ä¸­çš„ç‰ˆæœ¬ä¸€è‡´
        GRADLE_VERSION=$(grep "^version=" gradle.properties | cut -d'=' -f2)
        TAG_VERSION=${{ steps.extract_version.outputs.VERSION }}
        echo "Gradle version: $GRADLE_VERSION"
        echo "Tag version: $TAG_VERSION"
        if [ "$GRADLE_VERSION" != "$TAG_VERSION" ]; then
          echo "Error: Version mismatch between gradle.properties ($GRADLE_VERSION) and tag ($TAG_VERSION)"
          exit 1
        fi
        echo "Version verification passed: $GRADLE_VERSION"

    - name: Make gradlew executable
      run: chmod +x gradlew

    - name: Build project
      run: ./gradlew clean build -x test
      # æ³¨æ„ï¼šç”±äºæµ‹è¯•éœ€è¦ TDengine æ•°æ®åº“ï¼Œè¿™é‡Œè·³è¿‡æµ‹è¯•
      # åœ¨å®é™…ç¯å¢ƒä¸­ï¼Œå¯ä»¥é…ç½® TDengine æœåŠ¡è¿›è¡Œå®Œæ•´æµ‹è¯•

    - name: Publish to Maven Central
      run: ./gradlew publishToMavenCentral --no-configuration-cache
      env:
        ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_USERNAME }}
        ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_TOKEN }}
        ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.GPG_KEY_ID }}
        ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.GPG_PASSPHRASE }}
        ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_PRIVATE_KEY }}

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        tag_name: ${{ github.ref_name }}
        name: Release ${{ steps.extract_version.outputs.VERSION }}
        body: |
          ## ğŸ“¦ TDengine ORM Boot Starter ${{ steps.extract_version.outputs.VERSION }}

          ### ğŸš€ Maven ä¾èµ–
          ```xml
          <dependency>
              <groupId>io.github.zephyrcicd</groupId>
              <artifactId>tdengine-orm-boot-starter</artifactId>
              <version>${{ steps.extract_version.outputs.VERSION }}</version>
          </dependency>
          ```

          ### ğŸ¯ Gradle ä¾èµ– (Kotlin DSL)
          ```kotlin
          implementation("io.github.zephyrcicd:tdengine-orm-boot-starter:${{ steps.extract_version.outputs.VERSION }}")
          ```

          ### ğŸ“¦ Gradle ä¾èµ– (Groovy)
          ```groovy
          implementation 'io.github.zephyrcicd:tdengine-orm-boot-starter:${{ steps.extract_version.outputs.VERSION }}'
          ```

          ### ğŸ“‹ æ›´æ–°å†…å®¹
          è¯¦ç»†æ›´æ–°å†…å®¹è¯·æŸ¥çœ‹æäº¤å†å²ã€‚

          ### ğŸ”— é“¾æ¥
          - [Maven Central](https://central.sonatype.com/artifact/io.github.zephyrcicd/tdengine-orm-boot-starter/${{ steps.extract_version.outputs.VERSION }})
          - [æ–‡æ¡£](https://github.com/zephyrcicd/tdengine-orm-boot-starter/blob/main/README.md)
          - [Gradle æ„å»ºæŒ‡å—](https://github.com/zephyrcicd/tdengine-orm-boot-starter/blob/main/README_GRADLE.md)
        draft: false
        prerelease: false
