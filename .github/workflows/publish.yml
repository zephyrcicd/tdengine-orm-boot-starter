name: Publish to Maven Central

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v1.2.1, v1.3.0 ç­‰æ ‡ç­¾æ—¶è§¦å‘

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Extract version from tag
      id: extract_version
      run: |
        # ä»æ ‡ç­¾ä¸­æå–ç‰ˆæœ¬å· (v1.2.1 -> 1.2.1)
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: $VERSION"

    - name: Verify version matches pom.xml
      run: |
        # æ£€æŸ¥æ ‡ç­¾ç‰ˆæœ¬æ˜¯å¦ä¸ pom.xml ä¸­çš„ç‰ˆæœ¬ä¸€è‡´
        POM_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        TAG_VERSION=${{ steps.extract_version.outputs.VERSION }}
        echo "POM version: $POM_VERSION"
        echo "Tag version: $TAG_VERSION"
        if [ "$POM_VERSION" != "$TAG_VERSION" ]; then
          echo "Error: Version mismatch between pom.xml ($POM_VERSION) and tag ($TAG_VERSION)"
          exit 1
        fi
        echo "Version verification passed: $POM_VERSION"

    - name: Build project
      run: mvn clean package -DskipTests
      # æ³¨æ„ï¼šç”±äºæµ‹è¯•éœ€è¦ TDengine æ•°æ®åº“ï¼Œè¿™é‡Œè·³è¿‡æµ‹è¯•

    - name: Import GPG key
      run: |
        echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
      env:
        GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}

    - name: Configure Maven settings
      run: |
        mkdir -p ~/.m2
        cat > ~/.m2/settings.xml << 'EOF'
        <settings>
          <servers>
            <server>
              <id>central</id>
              <username>${env.MAVEN_USERNAME}</username>
              <password>${env.MAVEN_CENTRAL_TOKEN}</password>
            </server>
          </servers>
          <profiles>
            <profile>
              <id>central</id>
              <activation>
                <activeByDefault>true</activeByDefault>
              </activation>
              <properties>
                <gpg.keyname>${env.GPG_KEY_ID}</gpg.keyname>
                <gpg.passphrase>${env.GPG_PASSPHRASE}</gpg.passphrase>
              </properties>
            </profile>
          </profiles>
        </settings>
        EOF

    - name: Publish to Maven Central
      run: mvn deploy -DskipTests
      env:
        MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
        MAVEN_CENTRAL_TOKEN: ${{ secrets.MAVEN_CENTRAL_TOKEN }}
        GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        tag_name: ${{ github.ref_name }}
        name: Release ${{ steps.extract_version.outputs.VERSION }}
        body: |
          ## ğŸ“¦ TDengine ORM ${{ steps.extract_version.outputs.VERSION }}

          æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªå¤šæ¨¡å— Maven é¡¹ç›®ï¼ŒåŒ…å«ä»¥ä¸‹æ¨¡å—ï¼š
          - `tdengine-orm-annotation` - è½»é‡çº§æ³¨è§£æ¨¡å—ï¼ˆå¯ç‹¬ç«‹ä½¿ç”¨ï¼‰
          - `tdengine-orm-boot-starter` - å®Œæ•´çš„ Spring Boot Starter

          ### ğŸš€ Maven ä¾èµ–

          **å®Œæ•´ ORM åŠŸèƒ½ï¼ˆSpring Boot é¡¹ç›®ï¼‰ï¼š**
          ```xml
          <dependency>
              <groupId>io.github.zephyrcicd</groupId>
              <artifactId>tdengine-orm-boot-starter</artifactId>
              <version>${{ steps.extract_version.outputs.VERSION }}</version>
          </dependency>
          ```

          **ä»…æ³¨è§£ï¼ˆå®ä½“ç±»é¡¹ç›®ï¼‰ï¼š**
          ```xml
          <dependency>
              <groupId>io.github.zephyrcicd</groupId>
              <artifactId>tdengine-orm-annotation</artifactId>
              <version>${{ steps.extract_version.outputs.VERSION }}</version>
          </dependency>
          ```

          ### ğŸ¯ Gradle ä¾èµ– (Kotlin DSL)
          ```kotlin
          // å®Œæ•´åŠŸèƒ½
          implementation("io.github.zephyrcicd:tdengine-orm-boot-starter:${{ steps.extract_version.outputs.VERSION }}")
          // ä»…æ³¨è§£
          implementation("io.github.zephyrcicd:tdengine-orm-annotation:${{ steps.extract_version.outputs.VERSION }}")
          ```

          ### ğŸ“¦ Gradle ä¾èµ– (Groovy)
          ```groovy
          // å®Œæ•´åŠŸèƒ½
          implementation 'io.github.zephyrcicd:tdengine-orm-boot-starter:${{ steps.extract_version.outputs.VERSION }}'
          // ä»…æ³¨è§£
          implementation 'io.github.zephyrcicd:tdengine-orm-annotation:${{ steps.extract_version.outputs.VERSION }}'
          ```

          ### ğŸ“‹ æ›´æ–°å†…å®¹
          è¯¦ç»†æ›´æ–°å†…å®¹è¯·æŸ¥çœ‹æäº¤å†å²ã€‚

          ### ğŸ”— é“¾æ¥
          - [Maven Central - boot-starter](https://central.sonatype.com/artifact/io.github.zephyrcicd/tdengine-orm-boot-starter/${{ steps.extract_version.outputs.VERSION }})
          - [Maven Central - annotation](https://central.sonatype.com/artifact/io.github.zephyrcicd/tdengine-orm-annotation/${{ steps.extract_version.outputs.VERSION }})
          - [æ–‡æ¡£](https://github.com/zephyrcicd/tdengine-orm-boot-starter/blob/main/README.md)
        draft: false
        prerelease: false